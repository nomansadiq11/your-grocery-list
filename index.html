<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Grocer List PWA (URL Sharing)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#60a5fa',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .container-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for checked items */
        .checked-item {
            text-decoration: line-through;
            opacity: 0.6;
            background-color: #f0fdf4; /* A light green for checked background */
        }
        .app-shell {
            max-width: 600px;
            margin: auto;
            min-height: 100vh;
            background: white;
            padding: 0;
        }
    </style>
</head>
<body class="p-4 bg-gray-100">

    <div id="app-shell" class="app-shell container-shadow rounded-lg overflow-hidden">
        <!-- Header -->
        <header class="bg-primary text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-bold">Shared Grocery List</h1>
            <div id="connection-status" class="text-sm font-medium flex items-center">
                <span id="sync-dot" class="w-2 h-2 rounded-full mr-2 bg-yellow-400 transition-colors duration-500"></span>
                <span id="sync-text">URL Sync Only</span>
            </div>
        </header>

        <main class="p-4">

            <!-- Connection/Status Screen -->
            <div id="status-info" class="text-xs text-gray-500 mb-4 bg-gray-50 p-2 rounded-lg text-center">
                List status: Loaded from URL or new list started.
            </div>

            <!-- Grocery List Display -->
            <div id="list-container">
                <div id="active-code-display" class="text-center mb-4 p-3 bg-secondary text-white rounded-lg shadow-md">
                    <p class="text-sm font-medium">To share updates, click below:</p>
                    <button onclick="copyCode()" class="mt-1 text-sm font-extrabold underline hover:opacity-80 transition">
                        Tap to Copy Shareable Link
                    </button>
                    <p class="mt-2 text-xs opacity-80">
                        (Note: Sharing is not real-time. You must share a new link after every change.)
                    </p>
                </div>

                <!-- Category and Item Management -->
                <div id="list-items" class="space-y-6">
                    <!-- List items will be injected here -->
                </div>

                <!-- Add Item/Category Form -->
                <div class="mt-8 p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                    <h3 class="text-lg font-semibold mb-3 text-primary">Add New Item or Category</h3>
                    <input type="text" id="new-item-text" placeholder="e.g., Bananas, or New Category Name" class="w-full p-2 border rounded-lg mb-2 focus:border-secondary transition">
                    <select id="category-select" class="w-full p-2 border rounded-lg mb-3 bg-white focus:border-secondary transition">
                        <!-- Options will be populated here -->
                    </select>
                    <button id="add-item-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-200">
                        Add to List
                    </button>
                    <button id="add-category-btn" class="w-full mt-2 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 rounded-lg transition duration-200">
                        Create New Category
                    </button>
                </div>
            </div>

            <!-- Custom Modal for Confirmation/Alerts -->
            <div id="custom-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 space-y-4">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                    <p id="modal-message" class="text-gray-600"></p>
                    <div id="modal-actions" class="flex justify-end space-x-3">
                        <!-- Buttons injected by showModal -->
                    </div>
                </div>
            </div>

            <p id="error-message" class="text-red-500 text-sm hidden mt-4 p-2 bg-red-50 rounded-lg"></p>


        </main>
    </div>

    <script type="module">
        // --- CONSTANTS AND STATE ---
        const LIST_QUERY_PARAM = 'list';
        const INITIAL_LIST_DATA = {
            categories: [
                { name: "Bakery Items", items: [] },
                { name: "Produce (Fruits & Veg)", items: [] }
            ]
        };
        let listData = {}; // Local state copy of the list

        // --- DOM Elements ---
        const listItemsContainer = document.getElementById('list-items');
        const categorySelect = document.getElementById('category-select');
        const newItemText = document.getElementById('new-item-text');
        const addItemBtn = document.getElementById('add-item-btn');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const errorMessage = document.getElementById('error-message');
        const syncDot = document.getElementById('sync-dot');
        const syncText = document.getElementById('sync-text');

        // --- UTILITY FUNCTIONS ---

        // Function to show custom modal (replacing alert/confirm)
        function showModal(title, message, actions) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const actionsDiv = document.getElementById('modal-actions');
            actionsDiv.innerHTML = '';

            actions.forEach(action => {
                const button = document.createElement('button');
                button.textContent = action.text;
                button.className = `font-bold py-2 px-4 rounded-lg transition duration-200 ${action.isPrimary ? 'bg-primary text-white hover:bg-indigo-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                button.onclick = () => {
                    action.handler();
                    modal.classList.add('hidden');
                };
                actionsDiv.appendChild(button);
            });

            modal.classList.remove('hidden');
        }

        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => { errorMessage.classList.add('hidden'); }, 5000);
        }

        // --- DATA ENCODING & URL MANAGEMENT ---

        /**
         * Encodes the current listData state into a compressed, URL-safe string.
         * The list is JSON stringified, then Base64 encoded.
         * @returns {string} The encoded list string.
         */
        function encodeListData() {
            try {
                const jsonString = JSON.stringify(listData);
                // Use btoa for Base64 encoding (URL safe enough for this purpose)
                return btoa(jsonString);
            } catch (e) {
                console.error("Error encoding list data:", e);
                displayError("Error encoding list data for sharing.");
                return '';
            }
        }

        /**
         * Decodes the list data from a Base64 encoded string.
         * @param {string} encodedData - The Base64 encoded list string.
         * @returns {object|null} The decoded list object, or null on failure.
         */
        function decodeListData(encodedData) {
            try {
                // Decode Base64, then parse JSON
                const jsonString = atob(encodedData);
                const data = JSON.parse(jsonString);
                // Basic validation
                if (data && Array.isArray(data.categories)) {
                    return data;
                }
                return null;
            } catch (e) {
                console.error("Error decoding list data:", e);
                displayError("Error decoding list from URL. Starting new list.");
                return null;
            }
        }

        /**
         * Updates the browser history (URL) with the latest list data.
         * This is necessary to generate the shareable link.
         */
        function updateUrlWithListData() {
            const encodedData = encodeListData();
            if (!encodedData) return;

            const url = new URL(window.location.href);
            url.searchParams.set(LIST_QUERY_PARAM, encodedData);

            // Use replaceState to avoid cluttering history when editing frequently
            window.history.replaceState({ list: encodedData }, '', url.toString());

            // Optional: Visually confirm the change
            syncDot.classList.remove('bg-yellow-400');
            syncDot.classList.add('bg-blue-400');
            syncText.textContent = 'Link Updated';
            setTimeout(() => {
                syncDot.classList.remove('bg-blue-400');
                syncDot.classList.add('bg-yellow-400');
                syncText.textContent = 'URL Sync Only';
            }, 1000);
        }

        // --- LIST MANAGEMENT LOGIC ---

        function updateListAndRender() {
            renderList();
            updateUrlWithListData();
        }


        function handleAddItemOrCategory(isCategory) {
            const text = newItemText.value.trim();
            if (!text) {
                displayError("Please enter a name for the item or category.");
                return;
            }

            let updatedCategories = JSON.parse(JSON.stringify(listData.categories || []));

            if (isCategory) {
                // Add New Category
                const categoryExists = updatedCategories.some(c => c.name.toLowerCase() === text.toLowerCase());
                if (categoryExists) {
                    displayError(`Category "${text}" already exists.`);
                    return;
                }
                updatedCategories.push({ name: text, items: [] });
            } else {
                // Add New Item to Selected Category
                const selectedCategoryName = categorySelect.value;
                const categoryIndex = updatedCategories.findIndex(c => c.name === selectedCategoryName);

                if (categoryIndex === -1) {
                    displayError("Please select a valid category.");
                    return;
                }

                // Check for duplicate item (case-insensitive and trimmed)
                const itemExists = updatedCategories[categoryIndex].items.some(item => item.text.trim().toLowerCase() === text.toLowerCase());
                if (itemExists) {
                    displayError(`Item "${text}" already in "${selectedCategoryName}".`);
                    return;
                }

                // Add item to the list
                updatedCategories[categoryIndex].items.push({
                    text: text,
                    checked: false
                });
            }

            listData.categories = updatedCategories;
            newItemText.value = ''; // Clear input field
            updateListAndRender();
        }

        function toggleItemChecked(categoryIndex, itemIndex) {
            const item = listData.categories[categoryIndex].items[itemIndex];
            item.checked = !item.checked;
            updateListAndRender();
        }

        function deleteItem(categoryIndex, itemIndex) {
            listData.categories[categoryIndex].items.splice(itemIndex, 1);
            updateListAndRender();
        }

        function deleteCategory(categoryIndex) {
             showModal('Confirm Deletion', `Are you sure you want to delete the category "${listData.categories[categoryIndex].name}"? All items inside will be lost.`, [
                { text: 'Cancel', isPrimary: false, handler: () => {} },
                { text: 'Delete', isPrimary: true, handler: () => {
                    listData.categories.splice(categoryIndex, 1);
                    updateListAndRender();
                } }
            ]);
        }

        // --- UI RENDERING ---

        function renderList() {
            listItemsContainer.innerHTML = '';
            categorySelect.innerHTML = '';

            const categories = listData.categories || [];

            if (categories.length === 0) {
                listItemsContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No categories found. Use the form below to add one!</p>';
                categorySelect.innerHTML = '<option value="" disabled selected>No Categories Available</option>';
                return;
            }

            // 1. Render Category Select Options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            // 2. Render List Structure
            categories.forEach((category, catIndex) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'bg-white rounded-xl shadow-lg p-4 mb-6';

                // Category Header
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-3 pb-2 border-b-2 border-primary/20';

                const title = document.createElement('h3');
                title.className = 'text-lg font-extrabold text-primary flex items-center';
                title.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2zM11 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" /></svg><span>${category.name}</span>`;
                header.appendChild(title);

                const deleteCatBtn = document.createElement('button');
                deleteCatBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full';
                deleteCatBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                deleteCatBtn.onclick = () => deleteCategory(catIndex);
                header.appendChild(deleteCatBtn);

                categoryDiv.appendChild(header);

                // Items List
                const ul = document.createElement('ul');
                ul.className = 'space-y-2';

                if (category.items && category.items.length > 0) {
                    // Separate checked and unchecked items for sorting
                    const uncheckedItems = category.items.filter(item => !item.checked);
                    const checkedItems = category.items.filter(item => item.checked);
                    const sortedItems = [...uncheckedItems, ...checkedItems]; // Unchecked first

                    sortedItems.forEach((item, itemIndex) => {
                        // Find original index in category.items to keep the data mapping correct for updates
                        const originalIndex = category.items.findIndex(i => i.text === item.text && i.checked === item.checked);

                        const li = document.createElement('li');
                        li.className = `flex items-center justify-between p-3 rounded-lg transition duration-150 cursor-pointer ${item.checked ? 'checked-item' : 'hover:bg-gray-50'}`;

                        // Checkbox and Text
                        const leftSide = document.createElement('div');
                        leftSide.className = 'flex items-center flex-1 min-w-0';
                        leftSide.onclick = () => toggleItemChecked(catIndex, originalIndex); // Toggle on click of left side

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = item.checked;
                        checkbox.className = 'h-5 w-5 text-primary border-gray-300 rounded focus:ring-primary mr-3';
                        leftSide.appendChild(checkbox);

                        const itemText = document.createElement('span');
                        itemText.textContent = item.text;
                        itemText.className = 'text-gray-800 break-words';
                        leftSide.appendChild(itemText);
                        li.appendChild(leftSide);

                        // Delete Button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'text-gray-400 hover:text-red-500 p-2 rounded-full transition duration-150 flex-shrink-0';
                        deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>';
                        deleteBtn.onclick = () => deleteItem(catIndex, originalIndex);
                        li.appendChild(deleteBtn);

                        ul.appendChild(li);
                    });
                } else {
                    ul.innerHTML = '<li class="text-gray-400 text-sm italic p-2">List is empty. Add an item!</li>';
                }

                categoryDiv.appendChild(ul);
                listItemsContainer.appendChild(categoryDiv);
            });
        }

        /**
         * Initializes the list data from the URL or starts a new list.
         */
        function initializeListFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const encodedData = params.get(LIST_QUERY_PARAM);

            if (encodedData) {
                const decodedData = decodeListData(encodedData);
                if (decodedData) {
                    listData = decodedData;
                    // For local state, we also save it to localStorage for persistence across tab closes
                    localStorage.setItem('groceryList', JSON.stringify(listData));
                    document.getElementById('status-info').textContent = "List status: Loaded from URL link.";
                } else {
                    // Decoding failed, load from local storage or start new
                    loadFromLocalStorageOrNew();
                }
            } else {
                // No list in URL, check localStorage
                loadFromLocalStorageOrNew();
            }
            renderList();
        }

        function loadFromLocalStorageOrNew() {
             const localData = localStorage.getItem('groceryList');
             if (localData) {
                try {
                    listData = JSON.parse(localData);
                    document.getElementById('status-info').textContent = "List status: Loaded from local browser storage.";
                    // Update URL so it's ready to be shared
                    updateUrlWithListData();
                } catch(e) {
                    listData = INITIAL_LIST_DATA;
                    document.getElementById('status-info').textContent = "List status: New list started (Local Storage Corrupted).";
                }
            } else {
                listData = INITIAL_LIST_DATA;
                document.getElementById('status-info').textContent = "List status: New list started.";
            }
        }

        // --- EVENT LISTENERS & INIT ---

        document.addEventListener('DOMContentLoaded', () => {
            // Load list data
            initializeListFromUrl();

            // Add Item/Category Listeners
            addItemBtn.addEventListener('click', () => handleAddItemOrCategory(false));
            addCategoryBtn.addEventListener('click', () => handleAddItemOrCategory(true));

            // Allow ENTER key to add item
            newItemText.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    handleAddItemOrCategory(false);
                }
            });

            // PWA Registration Simulation
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                        .then(registration => console.log('SW registered: ', registration.scope))
                        .catch(registrationError => console.log('SW registration failed: ', registrationError));
                });
            }

            // Function to copy the new shareable URL to clipboard
            window.copyCode = function() {
                // Ensure the URL is up to date before copying
                updateUrlWithListData();
                const shareUrl = window.location.href;

                const tempInput = document.createElement('textarea');
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showModal('Link Copied!', `The full list link has been copied to your clipboard. Share this link to send the latest version of the list!`, [
                    { text: 'Got it!', isPrimary: true, handler: () => {} }
                ]);
            }

            // Store changes in localStorage immediately to maintain persistence on reload
            const updateAndStore = (func) => {
                func();
                localStorage.setItem('groceryList', JSON.stringify(listData));
            }

            // Override core list functions to include localStorage saving
            window.toggleItemChecked = (catIndex, itemIndex) => updateAndStore(() => toggleItemChecked(catIndex, itemIndex));
            window.deleteItem = (catIndex, itemIndex) => updateAndStore(() => deleteItem(catIndex, itemIndex));
            window.deleteCategory = (catIndex) => updateAndStore(() => deleteCategory(catIndex));
            addItemBtn.onclick = () => updateAndStore(() => handleAddItemOrCategory(false));
            addCategoryBtn.onclick = () => updateAndStore(() => handleAddItemOrCategory(true));
        });

    </script>

    <!-- PWA Manifest Simulation (Note: In a real PWA, this would be a separate file) -->
    <link rel="manifest" href="data:application/json;base64,eyJpY29ucyI6IFt7InNpemVzIjogIjE5MngxOTAiLCAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTAiLCAidHlwZSI6ICJpbWFnZS9wbmciLCAiZGVub21pbmF0b3IiOiAiY2FudmFzIn0sIHsic2l6ZXMiOiAiMjU2eDI1NiIsICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMjU2eDI1NiIsICJ0eXBlIjogImltYWdlL3BuZyIsICJkZW5vbWluYXRvciI6ICJjYW52YXMifSwgeyJzaXplcyI6ICIzODR4Mzg0IiwgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8zODR4Mzg0IiwgInR5cGUiOiAiaW1hZ2UvcG5nIiwgImRlbm9taW5hdG9yIjogImNhbnZhcyJ9LCB7InNpemVzIjogIjUxMng1MTIiLCAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9wbmciLCAiZGVub21pbmF0b3IiOiAiY2FudmFzIn1dLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgIm5hbWUiOiAiU2hhcmVkIEdyb2NlcnkgTGlzdCIsICJzaG9ydF9uYW1lIjogIkdyb2NlcnlMaXN0IiwgInN0YXJ0X3VybCI6ICIuLyIsICJ0aGVtZV9jb2xvciI6ICIjNGY0NjU1IiwgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiJ9">
</body>
</html>
